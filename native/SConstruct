#!/usr/bin/env python
import os

# --------------------------------------------------------------
# Configuration (Generated by ChatGPT)
# --------------------------------------------------------------
# Name of the module (used to name the final DLL)
module_name = "life_particles"

# Path to the Godot project's 'bin' directory where the DLL will be placed
godot_bin_path = "../godot/bin"

# Path to the godot-cpp bindings (submodule)
godot_cpp_path = "godot-cpp"

# Path to your C++ source files
src_path = "src"

# Path to your header files
include_path = "include"


# --------------------------------------------------------------
# Load the build environment from godot-cpp
# --------------------------------------------------------------
# This imports the SConstruct logic from the godot-cpp repository
# and provides a configured SCons environment for building modules.
env = SConscript(os.path.join(godot_cpp_path, "SConstruct"))


# --------------------------------------------------------------
# Add include directories
# --------------------------------------------------------------
# This ensures that your headers (in include/) can be found when compiling.
# Required if your .cpp files use: #include "cuda_particles_renderer.h"
env.Append(CPPPATH=[os.path.abspath(include_path)])


# --------------------------------------------------------------
# Collect all .cpp files in src/
# --------------------------------------------------------------
sources = Glob(f"{src_path}/*.cpp")

# --------------------------------------------------------------
# CUDA integration (compiling .cu files with nvcc)
# --------------------------------------------------------------
cuda_sources = Glob(f"{src_path}/*.cu")

env_nvcc = env.Clone()  # Duplicate build environment for CUDA

# Adjust PATH so nvcc is found (Windows or Linux)
env_nvcc['ENV']['PATH'] = os.environ['PATH']

# Path to CUDA bin (Linux/macOS)
env_nvcc.AppendENVPath('PATH', '/usr/local/cuda/bin')

# WINDOWS: uncomment one of these depending on install:
# env_nvcc.AppendENVPath('PATH', 'C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.3/bin')
# env_nvcc.AppendENVPath('PATH', 'C:/Program Files/NVIDIA Corporation/NVSMI')

# Replace CXX with NVCC for .cu
env_nvcc['CXX'] = 'nvcc'
env_nvcc['SHCXX'] = 'nvcc'

# Extra NVCC flags
env_nvcc.Append(CXXFLAGS=[
    "-Xcompiler", "/wd4819",   # suppress some warnings on MSVC
])

cuda_objects = env_nvcc.SharedObject(cuda_sources)


# --------------------------------------------------------------
# Configure output DLL path
# --------------------------------------------------------------
# Example output on Windows:
#    ../godot/bin/liblife_particles.windows.template_debug.x86_64.dll
target = os.path.join(
    godot_bin_path,
    f"lib{module_name}{env['suffix']}{env['SHLIBSUFFIX']}"
)


# --------------------------------------------------------------
# Build the dynamic library (DLL / .so / .dylib)
# --------------------------------------------------------------
library = env.SharedLibrary(
    target=target,
    source=sources + cuda_objects,
)


# --------------------------------------------------------------
# Default build target
# --------------------------------------------------------------
Default(library)
